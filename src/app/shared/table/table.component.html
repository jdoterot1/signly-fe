<div
  class="p-4 sm:p-6 bg-brand-surface-card rounded-lg shadow"
  style="font-family: &quot;Poppins&quot;, sans-serif"
>
  <!-- HEADER: título, filtros, búsqueda y sort -->
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4">
    <h2 class="text-xl sm:text-2xl font-bold">{{ model.entityName | translate }}</h2>

    <!-- Mobile: Stack controls vertically -->
    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
      <!-- Row 1: Search bar (full width on mobile) -->
      <div class="relative flex-1 sm:flex-none">
        <img
          src="assets/icons/tables/Search.svg"
          alt="Search"
          class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4"
        />
        <input
          type="text"
          [placeholder]="'TABLE.SEARCH_PLACEHOLDER' | translate"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchTermChange()"
          class="w-full bg-brand-surface placeholder-brand-muted-light text-sm rounded-full pl-10 pr-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-accent"
        />
      </div>

      <!-- Row 2: Buttons in a row -->
      <div class="flex gap-2 sm:gap-3">
        <!-- Toggle fila de filtros -->
        <button
          (click)="openFiltersModal()"
          class="flex items-center justify-center rounded-full p-2 transition flex-shrink-0"
          [ngClass]="
            hasActiveFilters
              ? 'bg-brand-surface-alt text-brand-accent'
              : 'bg-brand-surface hover:bg-brand-surface-raised'
          "
          [attr.aria-label]="'TABLE.FILTERS' | translate"
        >
          <app-icon
            name="filter"
            class="w-5 h-5 text-brand-muted transition-colors"
          ></app-icon>
        </button>

        <!-- Sort by -->
        <div
          (click)="onSortToggle()"
          class="flex items-center bg-brand-surface rounded-full px-3 sm:px-4 py-2 cursor-pointer select-none flex-1 sm:flex-none"
        >
          <span class="text-xs sm:text-sm text-gray-700 truncate">
            {{ "TABLE.SORT_BY" | translate }}:
            <span class="font-bold">{{ sortLabel | translate }}</span>
          </span>
          <img
            src="assets/icons/tables/ChevronDown.svg"
            alt="Toggle sort"
            class="w-4 h-4 ml-2 flex-shrink-0"
          />
        </div>

        <!-- Create button -->
        <button
          *ngIf="config.showCreateButton !== false"
          type="button"
          (click)="onCreate()"
          class="bg-brand-primary text-white px-3 sm:px-4 py-2 rounded-full hover:bg-brand-primary-hover transition text-sm font-medium whitespace-nowrap"
        >
          <span class="hidden sm:inline">{{ "TABLE.CREATE" | translate }}</span>
          <span class="sm:hidden">+</span>
        </button>
      </div>
    </div>
  </div>

  <!-- TABLE - Desktop view (hidden on mobile) -->
  <div class="hidden md:block overflow-x-auto w-full">
    <table class="min-w-full w-full table-fixed divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <!-- fila de headers -->
        <tr>
          <th *ngIf="config.showRowSelection" class="px-4 py-3">
            <input
              type="checkbox"
              [checked]="selectAll"
              (change)="toggleSelectAll()"
            />
          </th>
          <ng-container *ngFor="let col of columns">
            <th
              *ngIf="col.visible"
              (click)="onSortOptionChange(col)"
              class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer select-none"
            >
              <div class="inline-flex items-center space-x-1">
                <span>{{ col.header | translate }}</span>
                <img
                  *ngIf="col.sortable"
                  src="assets/icons/tables/ChevronDown.svg"
                  alt="Sort"
                  class="w-3 h-3 transform"
                  [class.rotate-180]="
                    state.sortBy === col.key && state.sortDir === 'desc'
                  "
                />
              </div>
            </th>
          </ng-container>
        </tr>
      </thead>
      <tbody class="bg-brand-surface-card divide-y divide-gray-200">
        <tr *ngFor="let row of state.data.filteredData; trackBy: trackByFn">
          <td *ngIf="config.showRowSelection" class="px-4 py-4">
            <input
              type="checkbox"
              [checked]="isSelected(row)"
              (change)="toggleRow(row)"
            />
          </td>
          <ng-container *ngFor="let col of columns">
            <td
              *ngIf="col.visible"
              class="px-4 py-4 break-words whitespace-normal"
            >
              <ng-container *ngIf="col.key === 'status'; else normalCell">
                <span
                  class="inline-flex justify-center items-center w-24 px-2 py-1 rounded-full text-sm font-medium"
                  [ngClass]="statusClasses[getCellValue(row, col.key)]"
                >
                  <ng-container
                    *ngIf="col.statusTranslationPrefix; else normalCell"
                  >
                    {{
                      col.statusTranslationPrefix +
                        "." +
                        getCellValue(row, col.key) | translate
                    }}
                  </ng-container>
                </span>
              </ng-container>
              <ng-template #normalCell>
                <ng-container [ngSwitch]="col.columnType">
                  <ng-container *ngSwitchCase="'action'">
                    <div class="inline-flex space-x-4 justify-center w-full">
                      <ng-container *ngFor="let action of col.actions">
                        <!-- ACTIVO -->
                        <button
                          *ngIf="!isActionDisabled(action, row)"
                          type="button"
                          class="p-0 bg-transparent border-none cursor-pointer"
                          (click)="onActionClick(action, row, $event)"
                          [title]="action.tooltip | translate"
                        >
                          <app-icon
                            [name]="action.icon"
                            class="w-6 h-6 text-brand-muted hover:text-brand-primary transition-colors"
                          ></app-icon>
                        </button>

                        <!-- DISABLED -->
                        <app-icon
                          *ngIf="isActionDisabled(action, row)"
                          [name]="action.icon"
                          class="w-6 h-6 text-brand-muted opacity-40"
                        ></app-icon>
                      </ng-container>
                    </div>
                  </ng-container>
                  <ng-container *ngSwitchDefault>
                    <ng-container
                      *ngIf="isTruncatableKey(col.key); else defaultCell"
                    >
                      <span
                        class="inline-block max-w-xs truncate align-middle cursor-help"
                        [pTooltip]="asText(getCellValue(row, col.key))"
                        tooltipPosition="top"
                        [tooltipDisabled]="
                          asText(getCellValue(row, col.key)).length <=
                          (truncateLimitForKey(col.key) ?? 0)
                        "
                      >
                        {{
                          asText(getCellValue(row, col.key))
                            | slice: 0 : truncateLimitForKey(col.key) ?? 0
                        }}
                        <ng-container
                          *ngIf="
                            asText(getCellValue(row, col.key)).length >
                            (truncateLimitForKey(col.key) ?? 0)
                          "
                          >...</ng-container
                        >
                      </span>
                    </ng-container>
                    <ng-template #defaultCell>
                      <ng-container *ngIf="col.translate; else plainText">
                        {{ getCellValue(row, col.key) | translate }}
                      </ng-container>
                      <ng-template #plainText>
                        {{ getCellValue(row, col.key) }}
                      </ng-template>
                    </ng-template>
                  </ng-container>
                </ng-container>
              </ng-template>
            </td>
          </ng-container>
        </tr>
        <tr *ngIf="!state.data.filteredData.length">
          <td
            [attr.colspan]="
              (config.showRowSelection ? 1 : 0) + visibleColumnsCount()
            "
            class="px-4 py-4 text-center text-gray-500"
          >
            {{ config.emptyMessage || ("TABLE.NO_DATA" | translate) }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- MOBILE CARD VIEW -->
  <div class="md:hidden space-y-3">
    <div
      *ngFor="let row of state.data.filteredData; trackBy: trackByFn"
      class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm"
    >
      <!-- Checkbox for selection -->
      <div *ngIf="config.showRowSelection" class="mb-3 flex items-center">
        <input
          type="checkbox"
          [checked]="isSelected(row)"
          (change)="toggleRow(row)"
          class="h-4 w-4 text-brand-accent focus:ring-brand-accent border-gray-300 rounded"
        />
        <label class="ml-2 text-sm text-gray-600">{{ 'TABLE.SELECT' | translate }}</label>
      </div>

      <!-- Display all visible columns as rows -->
      <div class="space-y-2">
        <ng-container *ngFor="let col of columns">
          <div *ngIf="col.visible && col.columnType !== 'action'" class="flex justify-between items-start gap-2">
            <span class="text-xs font-medium text-gray-500 uppercase flex-shrink-0">
              {{ col.header | translate }}:
            </span>
            <span class="text-sm text-gray-900 text-right break-words flex-1">
              <ng-container *ngIf="col.key === 'status'">
                <span
                  class="inline-flex justify-center items-center px-2 py-1 rounded-full text-xs font-medium"
                  [ngClass]="statusClasses[getCellValue(row, col.key)]"
                >
                  <ng-container *ngIf="col.statusTranslationPrefix">
                    {{
                      col.statusTranslationPrefix +
                        "." +
                        getCellValue(row, col.key) | translate
                    }}
                  </ng-container>
                  <ng-container *ngIf="!col.statusTranslationPrefix">
                    {{ getCellValue(row, col.key) }}
                  </ng-container>
                </span>
              </ng-container>
              <ng-container *ngIf="col.key !== 'status'">
                <ng-container *ngIf="col.translate">
                  {{ getCellValue(row, col.key) | translate }}
                </ng-container>
                <ng-container *ngIf="!col.translate">
                  {{ getCellValue(row, col.key) }}
                </ng-container>
              </ng-container>
            </span>
          </div>
        </ng-container>
      </div>

      <!-- Actions at the bottom -->
      <ng-container *ngFor="let col of columns">
        <div *ngIf="col.visible && col.columnType === 'action'" class="mt-3 pt-3 border-t border-gray-100 flex flex-wrap justify-center gap-2">
          <ng-container *ngFor="let action of col.actions">
            <button
              *ngIf="!isActionDisabled(action, row)"
              type="button"
              class="flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium transition flex-1 min-w-[100px]"
              [ngClass]="{
                'bg-brand-primary text-white hover:bg-brand-primary-hover': action.icon === 'edit',
                'bg-red-50 text-red-600 hover:bg-red-100': action.icon === 'delete',
                'bg-blue-50 text-blue-600 hover:bg-blue-100': action.icon === 'eye',
                'bg-gray-100 text-gray-700 hover:bg-gray-200': action.icon !== 'edit' && action.icon !== 'delete' && action.icon !== 'eye'
              }"
              (click)="onActionClick(action, row, $event)"
            >
              <app-icon [name]="action.icon" class="w-4 h-4 flex-shrink-0"></app-icon>
              <span class="truncate">{{ action.tooltip | translate }}</span>
            </button>

            <button
              *ngIf="isActionDisabled(action, row)"
              type="button"
              disabled
              class="flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium bg-gray-50 text-gray-400 cursor-not-allowed flex-1 min-w-[100px]"
            >
              <app-icon [name]="action.icon" class="w-4 h-4 flex-shrink-0"></app-icon>
              <span class="truncate">{{ action.tooltip | translate }}</span>
            </button>
          </ng-container>
        </div>
      </ng-container>
    </div>

    <!-- Empty state for mobile -->
    <div *ngIf="!state.data.filteredData.length" class="text-center py-8 text-gray-500">
      {{ config.emptyMessage || ("TABLE.NO_DATA" | translate) }}
    </div>
  </div>

  <!-- PAGINACIÓN -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mt-6 text-sm">
    <div class="text-brand-muted-light text-center sm:text-left">
      {{
        "TABLE.PAGINATION"
          | translate
            : {
                from: (state.data.currentPage - 1) * config.pageSize + 1,
                to:
                  (state.data.currentPage - 1) * config.pageSize +
                  state.data.filteredData.length,
                total: state.data.totalItems,
              }
      }}
    </div>

    <div class="inline-flex items-center justify-center">
      <img
        src="assets/icons/tables/MoveLeft.svg"
        alt="Previous"
        (click)="prevPage()"
        [class.cursor-pointer]="state.data.currentPage > 1"
        [class.opacity-50]="state.data.currentPage === 1"
        class="w-8 h-8 mx-1"
      />
      <ul class="inline-flex">
        <li *ngFor="let p of state.data.pages">
          <button
            (click)="goToPage(p)"
            [ngClass]="{
              'bg-brand-primary text-white': state.data.currentPage === p,
              'border border-gray-300 text-gray-700 hover:bg-gray-200':
                state.data.currentPage !== p,
            }"
            class="px-2 sm:px-3 py-1 mx-1 rounded text-sm"
          >
            {{ p }}
          </button>
        </li>
      </ul>
      <img
        src="assets/icons/tables/MoveRight.svg"
        alt="Next"
        (click)="nextPage()"
        [class.cursor-pointer]="state.data.currentPage < state.data.totalPages"
        [class.opacity-50]="state.data.currentPage === state.data.totalPages"
        class="w-8 h-8 mx-1"
      />
    </div>
  </div>

  <app-table-filters-modal
    [visible]="isFiltersModalOpen"
    [columns]="filterableColumns"
    [values]="modalColumnFilters"
    [hasActiveFilters]="hasActiveFilters"
    (close)="closeFiltersModal()"
    (clearFields)="clearModalFilters()"
    (clearFilters)="clearAllFilters()"
    (apply)="applyFiltersFromModal()"
  ></app-table-filters-modal>
</div>
