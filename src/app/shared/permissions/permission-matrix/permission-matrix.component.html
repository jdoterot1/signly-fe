<div class="w-full relative">
  <div class="overflow-y-auto flex flex-col" [ngStyle]="{ 'max-height': maxHeight }">
    <div class="flex justify-end gap-2 px-4 pt-3 pb-2 sticky top-0 z-20 bg-white border-b border-gray-200">
      <button
        type="button"
        class="text-xs font-semibold text-blue-600 hover:text-blue-700"
        (click)="selectAll()"
      >
        Seleccionar todos
      </button>
      <button
        type="button"
        class="text-xs font-semibold text-gray-500 hover:text-gray-600"
        (click)="deselectAll()"
      >
        Deseleccionar todos
      </button>
    </div>

    <!-- Header desktop -->
    <div *ngIf="showHeader" class="hidden sm:block sticky top-12 z-20 relative">
      <div class="absolute inset-x-0 -top-6 h-6 bg-white"></div>
      <div class="grid grid-cols-5 gap-0 border-b border-gray-200 bg-white shadow [box-shadow:0_4px_4px_rgba(0,0,0,0.08)]">
        <div class="p-4 text-sm font-medium text-gray-500">Módulos</div>
        <div class="bg-yellow-500 text-white text-center py-3 px-4 font-medium text-sm">Crear</div>
        <div class="bg-green-500 text-white text-center py-3 px-4 font-medium text-sm">Visualizar</div>
        <div class="bg-gray-800 text-white text-center py-3 px-4 font-medium text-sm">Editar</div>
        <div class="bg-red-500 text-white text-center py-3 px-4 font-medium text-sm">Eliminar</div>
      </div>
    </div>

    <!-- Header mobile -->
    <div
      *ngIf="showHeader"
      class="sm:hidden bg-white"
      [ngClass]="{ 'sticky top-0 z-10 border-b border-gray-200 shadow-sm': stickyHeader }"
    >
      <div class="px-4 pt-3 pb-2 text-xs text-gray-600">
        <div class="grid grid-cols-4 text-center gap-1 font-medium">
          <div>Crear</div>
          <div>Ver</div>
          <div>Editar</div>
          <div>Eliminar</div>
        </div>
      </div>
    </div>

    <div class="divide-y divide-gray-100">
      <ng-container *ngFor="let group of groupedRows; let i = index">
        <div
          class="bg-gray-50/50 px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide"
          [ngClass]="{ 'mt-3': i === 0 }"
        >
          {{ group.section }}
        </div>

        <div
          *ngFor="let row of group.items; trackBy: trackByRow"
          class="grid grid-cols-1 sm:grid-cols-5 gap-0 items-center bg-white"
        >
          <div class="px-6 py-4">
            <span class="text-gray-900 text-sm font-semibold">{{ row.label }}</span>
            <div *ngIf="row.section && row.section !== row.label" class="text-xs text-gray-500">
              {{ row.section }}
            </div>

            <!-- Mobile controls -->
            <div class="mt-3 flex items-center justify-between gap-2 sm:hidden">
              <button
                type="button"
                (click)="toggle(row.key, 'create')"
                [class]="getMobileButtonClass(row.key, 'create')"
                [attr.aria-label]="'Crear - ' + row.label"
                [attr.aria-pressed]="isActive(row.key, 'create')"
              >
                <span *ngIf="isActive(row.key, 'create')">✓</span>
              </button>
              <button
                type="button"
                (click)="toggle(row.key, 'view')"
                [class]="getMobileButtonClass(row.key, 'view')"
                [attr.aria-label]="'Visualizar - ' + row.label"
                [attr.aria-pressed]="isActive(row.key, 'view')"
              >
                <span *ngIf="isActive(row.key, 'view')">✓</span>
              </button>
              <button
                type="button"
                (click)="toggle(row.key, 'edit')"
                [class]="getMobileButtonClass(row.key, 'edit')"
                [attr.aria-label]="'Editar - ' + row.label"
                [attr.aria-pressed]="isActive(row.key, 'edit')"
              >
                <span *ngIf="isActive(row.key, 'edit')">✓</span>
              </button>
              <button
                type="button"
                (click)="toggle(row.key, 'delete')"
                [class]="getMobileButtonClass(row.key, 'delete')"
                [attr.aria-label]="'Eliminar - ' + row.label"
                [attr.aria-pressed]="isActive(row.key, 'delete')"
              >
                <span *ngIf="isActive(row.key, 'delete')">✓</span>
              </button>
            </div>
          </div>

          <!-- Desktop grid controls -->
          <div class="hidden sm:flex justify-center py-4">
            <div
              (click)="toggle(row.key, 'create')"
              [class]="getCircleClass(row.key, 'create')"
              [attr.title]="'Crear - ' + row.label"
              role="button"
              [attr.aria-pressed]="isActive(row.key, 'create')"
            >
              <span *ngIf="isActive(row.key, 'create')">✓</span>
            </div>
          </div>
          <div class="hidden sm:flex justify-center py-4">
            <div
              (click)="toggle(row.key, 'view')"
              [class]="getCircleClass(row.key, 'view')"
              [attr.title]="'Visualizar - ' + row.label"
              role="button"
              [attr.aria-pressed]="isActive(row.key, 'view')"
            >
              <span *ngIf="isActive(row.key, 'view')">✓</span>
            </div>
          </div>
          <div class="hidden sm:flex justify-center py-4">
            <div
              (click)="toggle(row.key, 'edit')"
              [class]="getCircleClass(row.key, 'edit')"
              [attr.title]="'Editar - ' + row.label"
              role="button"
              [attr.aria-pressed]="isActive(row.key, 'edit')"
            >
              <span *ngIf="isActive(row.key, 'edit')">✓</span>
            </div>
          </div>
          <div class="hidden sm:flex justify-center py-4">
            <div
              (click)="toggle(row.key, 'delete')"
              [class]="getCircleClass(row.key, 'delete')"
              [attr.title]="'Eliminar - ' + row.label"
              role="button"
              [attr.aria-pressed]="isActive(row.key, 'delete')"
            >
              <span *ngIf="isActive(row.key, 'delete')">✓</span>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</div>
