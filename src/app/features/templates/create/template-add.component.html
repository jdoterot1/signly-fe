<div class="min-h-[calc(100vh-8rem)] w-full pb-10">
  <app-guide-modal
    *ngIf="showGuideModal"
    title="Paso 1: crea tu plantilla"
    subtitle="Completa los datos base y mapea el archivo para continuar."
    [steps]="guideSteps"
    primaryLabel="Listo, crear plantilla"
    secondaryLabel="Cerrar"
    (primary)="startTemplateStep()"
    (closed)="closeGuideModal()"
  ></app-guide-modal>
  <div class="px-4 lg:px-10 pt-8">
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-3">
        <span
          class="flex h-10 w-10 items-center justify-center rounded-full text-white font-semibold"
          [ngClass]="currentStep === 1 ? 'bg-[#2b0f60]' : 'bg-[#c7beda]'"
        >
          1
        </span>
        <div>
          <p class="text-sm font-semibold heading-brand">Información básica</p>
          <p class="text-xs text-gray-500">Define nombre y descripción</p>
        </div>
      </div>
      <div class="flex-1 h-px bg-gray-200"></div>
      <div class="flex items-center gap-3">
        <span
          class="flex h-10 w-10 items-center justify-center rounded-full text-white font-semibold"
          [ngClass]="currentStep === 2 ? 'bg-[#2b0f60]' : 'bg-[#c7beda]'"
        >
          2
        </span>
        <div>
          <p class="text-sm font-semibold heading-brand">Mapeo del documento</p>
          <p class="text-xs text-gray-500">Diseña el flujo y campos</p>
        </div>
      </div>
    </div>
  </div>

  <form
    *ngIf="currentStep === 1"
    [formGroup]="stepForm"
    class="mx-4 mt-8 lg:mx-10 bg-white rounded-3xl border border-gray-100 shadow-xl shadow-indigo-50/60 p-8 space-y-6"
  >
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-1" for="templateName">Nombre de la plantilla</label>
      <input
        id="templateName"
        type="text"
        class="w-full rounded-2xl border border-gray-200 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#2b0f60] placeholder:text-gray-400"
        [class.border-red-400]="stepForm.controls.name.invalid && stepForm.controls.name.touched"
        formControlName="name"
        placeholder="Ej. Contrato de prestación de servicios"
      />
      <p *ngIf="stepForm.controls.name.invalid && stepForm.controls.name.touched" class="mt-1 text-xs text-red-500">
        Este campo es obligatorio.
      </p>
    </div>

    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-1" for="templateDescription">Descripción</label>
      <textarea
        id="templateDescription"
        rows="4"
        class="w-full rounded-2xl border border-gray-200 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#2b0f60] placeholder:text-gray-400"
        formControlName="description"
        placeholder="Describe brevemente el propósito de esta plantilla"
      ></textarea>
    </div>

    <div class="rounded-2xl border border-gray-100 shadow-sm p-6 bg-slate-50/60 space-y-2">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div>
            <p class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Documento a mapear</p>
            <p class="text-lg font-semibold heading-brand mt-1">
              {{ selectedFile?.name || 'Sin documento seleccionado' }}
            </p>
        </div>
        <button
          type="button"
          class="px-5 py-2.5 rounded-2xl border border-[#2b0f60] text-sm font-semibold text-[#2b0f60] hover:bg-[#f3effb]"
          (click)="openDocumentPicker()"
        >
          {{ selectedFile ? 'Cambiar documento' : 'Seleccionar documento' }}
        </button>
      </div>
      <p class="text-sm text-gray-500" *ngIf="selectedFile">
        {{ (selectedFile.size / 1024 / 1024) | number:'1.1-2' }} MB · {{ selectedFile.type || 'Formato detectado automáticamente' }}
      </p>
      <p class="text-sm text-gray-500" *ngIf="!selectedFile">
        Selecciona o arrastra un archivo Word o PDF antes de pasar al mapeador.
      </p>
    </div>

    <div class="flex flex-col sm:flex-row justify-end gap-3">
      <button type="button" class="px-5 py-2 rounded-2xl border border-gray-200 text-sm font-semibold text-gray-600" (click)="onCancel()">
        Cancelar
      </button>
      <button
        type="button"
        class="px-6 py-2 rounded-2xl bg-[#2b0f60] text-white text-sm font-semibold hover:bg-[#1b1034]"
        (click)="goToStepTwo()"
        [disabled]="isSaving"
      >
        Continuar
      </button>
    </div>
  </form>

  <section class="mt-6 space-y-8" [class.hidden]="currentStep !== 2" [attr.aria-hidden]="currentStep !== 2 ? true : null">
    <div class="px-4 lg:px-10">
      <p class="text-xs uppercase tracking-wide text-gray-500 font-semibold">
        Template ID:
        <span class="normal-case font-semibold text-gray-800 break-all">
          {{ templateId || 'Sin template (crea la plantilla primero)' }}
        </span>
      </p>
    </div>

    <div class="px-4 lg:px-10" [formGroup]="fieldsForm">
      <div class="bg-white rounded-3xl border border-gray-100 shadow-lg shadow-indigo-50/60 p-6">
        <div class="flex items-center justify-between gap-4">
          <div>
            <p class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Fields</p>
            <p class="text-lg font-semibold heading-brand mt-1">Campos de la plantilla</p>
          </div>
          <div class="flex flex-col sm:flex-row gap-3">
            <button
              type="button"
              class="px-4 py-2 rounded-2xl border border-gray-200 text-sm font-semibold text-gray-700 hover:bg-gray-50"
              (click)="addField()"
            >
              Agregar campo
            </button>
            <button
              type="button"
              class="px-4 py-2 rounded-2xl bg-[#2b0f60] text-white text-sm font-semibold hover:bg-[#1b1034] disabled:opacity-50"
              (click)="saveFields()"
              [disabled]="!templateId || isSaving"
            >
              Guardar campos
            </button>
          </div>
        </div>

        <div class="mt-4 overflow-x-auto" formArrayName="fields">
          <table class="min-w-full w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Página</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">x</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">y</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">w</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">h</th>
                <th class="px-3 py-2"></th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr *ngFor="let ctrl of fieldsArray.controls; let i = index" [formGroupName]="i">
                <td class="px-3 py-2">
                  <input formControlName="fieldName" class="w-48 rounded-lg border border-gray-200 px-2 py-1 text-sm" />
                </td>
                <td class="px-3 py-2">
                  <input formControlName="fieldType" class="w-28 rounded-lg border border-gray-200 px-2 py-1 text-sm" />
                </td>
                <td class="px-3 py-2">
                  <input formControlName="fieldCode" class="w-20 rounded-lg border border-gray-200 px-2 py-1 text-sm" />
                </td>
                <td class="px-3 py-2">
                  <input formControlName="page" class="w-16 rounded-lg border border-gray-200 px-2 py-1 text-sm" />
                </td>
                <td class="px-3 py-2">
                  <input formControlName="x" class="w-16 rounded-lg border border-gray-200 px-2 py-1 text-sm" />
                </td>
                <td class="px-3 py-2">
                  <input formControlName="y" class="w-16 rounded-lg border border-gray-200 px-2 py-1 text-sm" />
                </td>
                <td class="px-3 py-2">
                  <input formControlName="width" class="w-16 rounded-lg border border-gray-200 px-2 py-1 text-sm" />
                </td>
                <td class="px-3 py-2">
                  <input formControlName="height" class="w-16 rounded-lg border border-gray-200 px-2 py-1 text-sm" />
                </td>
                <td class="px-3 py-2 text-right">
                  <button
                    type="button"
                    class="px-3 py-1 rounded-lg border border-gray-200 text-sm text-gray-700 hover:bg-gray-50"
                    (click)="removeField(i)"
                  >
                    Quitar
                  </button>
                </td>
              </tr>
              <tr *ngIf="fieldsArray.length === 0">
                <td class="px-3 py-3 text-sm text-gray-500" colspan="9">
                  Sin campos. Agrega uno para empezar.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="-mx-2 sm:-mx-4 lg:-mx-10 bg-slate-50/70 py-6">
      <div class="px-2 sm:px-4 lg:px-10">
        <app-document-mapper (fileSelected)="onFileSelected($event)">
          <div mapper-actions class="flex items-center gap-2">
            <select
              class="h-8 rounded-full border border-gray-200 bg-white px-3 text-xs text-gray-700 focus:outline-none focus:ring-2 focus:ring-[#2b0f60] disabled:opacity-60"
              [formControl]="versionControl"
              [disabled]="!templateId || !versions.length"
              title="Versión"
            >
              <option [ngValue]="null" disabled>Versión</option>
              <option *ngFor="let v of versions" [ngValue]="v.code">{{ v.name }}</option>
            </select>

            <button
              type="button"
              class="hidden sm:inline-flex items-center px-3 py-1.5 rounded-full border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-60"
              (click)="downloadPdf()"
              [disabled]="!templateId || !versionControl.value"
            >
              Descargar PDF
            </button>

            <label
              class="hidden sm:inline-flex items-center px-3 py-1.5 rounded-full border border-gray-200 text-gray-600 hover:bg-gray-50 cursor-pointer"
              [attr.title]="selectedPdfName"
            >
              Seleccionar PDF
              <input type="file" accept="application/pdf" class="hidden" (change)="onPdfSelected($event)" />
            </label>

            <button
              type="button"
              class="inline-flex items-center px-4 py-1.5 rounded-full bg-[#2b0f60] text-white font-semibold text-xs hover:bg-[#25134e] disabled:opacity-50"
              (click)="uploadPdf()"
              [disabled]="!templateId || !versionControl.value || isUploadingPdf"
            >
              Subir PDF
            </button>
          </div>
        </app-document-mapper>
      </div>
    </div>

    <div class="px-4 lg:px-10 flex flex-col sm:flex-row justify-end gap-3">
      <button
        type="button"
        class="px-5 py-2 rounded-2xl border border-gray-200 text-sm font-semibold text-gray-600"
        (click)="goBackToStepOne()"
      >
        Regresar
      </button>
      <button
        type="button"
        class="px-6 py-2 rounded-2xl bg-[#2b0f60] text-white text-sm font-semibold hover:bg-[#1b1034] disabled:opacity-50"
        [disabled]="isSaving"
        (click)="saveTemplate()"
      >
        Guardar plantilla
      </button>
    </div>
  </section>
</div>
