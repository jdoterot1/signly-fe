<!-- src/app/features/documents/create/document-add.component.html -->
<app-guide-modal
  *ngIf="showGuideModal"
  title="Paso 2: crea tu documento"
  subtitle="Carga el archivo y completa los datos para dejarlo listo para firma."
  [steps]="guideSteps"
  primaryLabel="Listo, crear documento"
  secondaryLabel="Cerrar"
  (primary)="startDocumentStep()"
  (closed)="closeGuideModal()"
></app-guide-modal>

<div class="max-w-5xl w-full mx-auto mt-8 px-6 sm:px-10">
  <div class="flex items-center justify-between gap-4 flex-wrap">
    <div>
      <p class="text-xs font-semibold uppercase tracking-[0.2em] text-brand-primary">Creación de documento</p>
      <p class="text-sm text-gray-600 mt-1" *ngIf="currentStep === 1">Paso 1 de 2: Información del documento</p>
      <p class="text-sm text-gray-600 mt-1" *ngIf="currentStep === 2">Paso 2 de 2: Participantes</p>
    </div>
    <div class="flex items-center gap-3">
      <div class="flex items-center gap-2">
        <span
          class="flex h-8 w-8 items-center justify-center rounded-full text-xs font-semibold text-white"
          [ngClass]="currentStep === 1 ? 'bg-brand-primary' : 'bg-brand-disabled'"
        >
          1
        </span>
        <span class="text-xs font-semibold text-gray-600">Documento</span>
      </div>
      <div class="h-px w-8 bg-gray-300"></div>
      <div class="flex items-center gap-2">
        <span
          class="flex h-8 w-8 items-center justify-center rounded-full text-xs font-semibold text-white"
          [ngClass]="currentStep === 2 ? 'bg-brand-primary' : 'bg-brand-disabled'"
        >
          2
        </span>
        <span class="text-xs font-semibold text-gray-600">Participantes</span>
      </div>
    </div>
  </div>
</div>

<app-form
  [config]="formConfig"
  [form]="form"
  [initialData]="formInitialValues"
  [extraTemplate]="participantsTemplate"
  [submitLabel]="submitLabel"
  [cancelLabel]="cancelLabel"
  (submitForm)="onSubmit($event)"
  (cancelForm)="onCancel()"
></app-form>

<ng-template #participantsTemplate>
  <section *ngIf="currentStep === 2" class="space-y-4">
    <div class="rounded-xl border border-blue-100 bg-blue-50 p-4 text-sm text-blue-800">
      <p class="font-semibold mb-2">¿Cómo agregar firmantes?</p>
      <ol class="list-decimal list-inside space-y-1">
        <li>Completa los datos del participante.</li>
        <li>Si tienes varios firmantes, haz clic en <strong>Agregar participante</strong> para cada uno.</li>
        <li>Si es un solo firmante, puedes crear el documento directamente.</li>
        <li>Haz clic en <strong>Crear documento</strong>.</li>
      </ol>
    </div>

    <div class="flex items-center justify-between gap-3">
      <h3 class="text-base font-semibold text-gray-800">
        Participantes agregados ({{ participantsDraft.length }})
      </h3>
      <button
        type="button"
        class="px-4 py-2 text-sm font-semibold text-white bg-brand-primary hover:bg-brand-primary-hover rounded-xl shadow transition"
        (click)="addParticipant()"
      >
        Agregar participante
      </button>
    </div>

    <div *ngIf="hasParticipantDraftInForm()" class="rounded-xl border border-amber-200 bg-amber-50 p-3 text-sm text-amber-800">
      Tienes datos diligenciados. Al crear el documento se agregará este participante automáticamente.
    </div>

    <p *ngIf="!participantsDraft.length" class="text-sm text-gray-500">
      Completa los datos del participante. Si necesitas más de uno, usa "Agregar participante".
    </p>

    <div class="space-y-3" *ngIf="participantsDraft.length">
      <article
        *ngFor="let participant of participantsDraft; let i = index"
        class="border border-gray-200 rounded-xl p-4 bg-white"
      >
        <div class="flex items-start justify-between gap-4">
          <div class="space-y-1 text-sm text-gray-700">
            <p class="font-semibold text-gray-900">{{ participant.displayName }}</p>
            <p *ngIf="participant.identity.email">Email: {{ participant.identity.email }}</p>
            <p *ngIf="participant.identity.phone">Teléfono: {{ participant.identity.phone }}</p>
            <p *ngIf="participant.identity.documentNumber">Documento: {{ participant.identity.documentNumber }}</p>
            <p>Modos: {{ participant.signatureMode.join(', ') }}</p>
            <p>Flujo sin firma: {{ participant.signaturelessFlow ? 'Sí' : 'No' }}</p>
            <p *ngIf="participant.prefill?.length">Campos precompletados: {{ participant.prefill?.length }}</p>
          </div>
          <button
            type="button"
            class="px-3 py-1.5 text-xs font-semibold text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition"
            (click)="removeParticipant(i)"
          >
            Eliminar
          </button>
        </div>
      </article>
    </div>

    <section class="space-y-3 rounded-xl border border-gray-200 bg-white p-4">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h4 class="text-sm font-semibold text-gray-800">Opciones del participante</h4>
        <label class="inline-flex items-center gap-2 text-sm text-gray-700">
          <input
            type="checkbox"
            [checked]="participantUsePrefill"
            (change)="onParticipantUsePrefillChange(!!$any($event.target).checked)"
          />
          Precompletar campos del template
        </label>
        <label class="inline-flex items-center gap-2 text-sm text-gray-700">
          <input
            type="checkbox"
            [checked]="false"
            [disabled]="true"
          />
          Flujo sin firma manuscrita
        </label>
      </div>

      <div *ngIf="participantUsePrefill" class="rounded-lg border border-gray-200 bg-gray-50 p-3">
        <p class="text-xs text-gray-600 mb-2" *ngIf="!templateFieldNames.length">
          Esta versión del template no tiene campos disponibles para precompletar.
        </p>

        <div class="overflow-x-auto" *ngIf="templateFieldNames.length">
          <table class="min-w-full text-xs">
            <thead>
              <tr class="text-left text-gray-500">
                <th class="py-2 pr-3 font-semibold">Campo</th>
                <th class="py-2 pr-3 font-semibold">Valor</th>
                <th class="py-2 pr-1 font-semibold">Editable</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let fieldName of templateFieldNames" class="border-t border-gray-200">
                <td class="py-2 pr-3 font-medium text-gray-700">{{ fieldName }}</td>
                <td class="py-2 pr-3">
                  <input
                    type="text"
                    class="w-full rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-brand-primary"
                    [value]="getParticipantPrefillValue(fieldName)"
                    (input)="onParticipantPrefillValueChange(fieldName, $any($event.target).value)"
                    placeholder="Valor a precompletar"
                  />
                </td>
                <td class="py-2 pr-1">
                  <input
                    type="checkbox"
                    [checked]="getParticipantPrefillEditable(fieldName)"
                    (change)="onParticipantPrefillEditableChange(fieldName, !!$any($event.target).checked)"
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p class="text-xs text-gray-500">
        El prefill se configura aquí por participante usando la plantilla seleccionada. Los campos de firma no se pueden precompletar.
      </p>
    </section>
  </section>
</ng-template>
