<div class="min-h-full bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
  <div class="max-w-6xl mx-auto space-y-8">
    <section class="bg-white rounded-3xl border border-gray-100 shadow px-6 py-8">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.3em] text-[#2b0f60]">Calculadora</p>
          <h2 class="text-2xl font-semibold text-gray-900 mt-2">Créditos vs On-demand</h2>
          <p class="text-sm text-gray-600 mt-2 max-w-3xl">
            Define tu volumen mensual por tipo de firma y mira el costo estimado. Recuerda: <strong>1 crédito = 1 COP</strong>.
          </p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
          <div class="rounded-2xl border border-[#d6cdf4] shadow-sm overflow-hidden">
            <div class="flex bg-[#efe9ff]">
              <button
                type="button"
                class="px-4 py-2 text-sm font-semibold transition"
                [ngClass]="mode === 'credits' ? 'bg-white text-[#2b0f60] shadow-sm' : 'text-[#6b5a94]'"
                (click)="setMode('credits')"
              >
                Créditos (prepago)
              </button>
              <button
                type="button"
                class="px-4 py-2 text-sm font-semibold transition"
                [ngClass]="mode === 'ondemand' ? 'bg-white text-[#2b0f60] shadow-sm' : 'text-[#6b5a94]'"
                (click)="setMode('ondemand')"
              >
                On-demand (pospago)
              </button>
            </div>
          </div>

          <button
            type="button"
            class="px-4 py-2 rounded-xl border text-sm text-gray-700 hover:bg-gray-50 disabled:opacity-60"
            (click)="load()"
            [disabled]="isLoading"
          >
            {{ isLoading ? 'Actualizando...' : 'Actualizar precios' }}
          </button>
        </div>
      </div>

      <div class="mt-6 grid lg:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-indigo-100 bg-indigo-50/60 p-5 lg:col-span-2">
          <p class="text-sm text-gray-700 leading-relaxed">
            Los créditos aplican igual para biometría, email, SMS y WhatsApp.
            Lo que cambia es cuántos créditos consume cada documento, según el precio configurado en el API y el volumen.
          </p>
        </div>
        <div class="rounded-2xl border border-gray-200 bg-white p-5">
          <p class="text-xs font-semibold uppercase tracking-[0.25em] text-[#2b0f60]">Parámetros</p>
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-500">Región</label>
              <select
                class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-[#3366FF]"
                [(ngModel)]="region"
              >
                <option *ngFor="let r of availableRegions()" [value]="r">{{ r }}</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-500">Moneda</label>
              <select
                class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-[#3366FF]"
                [(ngModel)]="currency"
              >
                <option *ngFor="let c of availableCurrencies()" [value]="c">{{ c }}</option>
              </select>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-3">
            La estimación usa el tier que corresponde al volumen mensual que ingreses por canal.
          </p>
        </div>
      </div>

      <div *ngIf="isLoading" class="mt-6 text-sm text-gray-500 animate-pulse">
        Cargando calculadora...
      </div>

      <div *ngIf="!isLoading && estimates.length === 0" class="mt-6 text-sm text-gray-500">
        No hay precios disponibles para construir la calculadora.
      </div>

      <div *ngIf="!isLoading && estimates.length > 0" class="mt-6 grid lg:grid-cols-3 gap-5 items-start">
        <div class="lg:col-span-2 space-y-4 lg:max-h-[70vh] lg:overflow-y-auto lg:pr-2">
          <div
            *ngFor="let item of estimates"
            class="rounded-2xl border border-gray-100 bg-white p-5 shadow-sm"
          >
            <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
              <div>
                <p class="text-sm font-semibold text-gray-900">{{ item.meter.display_name }}</p>
                <p class="text-xs text-gray-600 mt-1">{{ item.meter.description }}</p>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-500">Créditos por documento</p>
                <p class="text-lg font-semibold text-gray-900 mt-1">
                  {{ creditsPerDoc(item) === null ? '—' : formatNumber(creditsPerDoc(item)!) }}
                </p>
                <p class="text-xs text-gray-500 mt-1">Escala {{ formatTierLabel(tierFor(item)) }}</p>
              </div>
            </div>

            <div class="mt-4 grid md:grid-cols-[1fr_140px] gap-4 items-center">
              <input
                type="range"
                class="w-full accent-[#361681]"
                min="0"
                max="5000"
                step="10"
                [ngModel]="item.qty"
                (ngModelChange)="setQty(item, $event)"
              />

              <div>
                <label class="text-xs text-gray-500">Docs/mes</label>
                <input
                  type="number"
                  min="0"
                  class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#3366FF]"
                  [ngModel]="item.qty"
                  (ngModelChange)="setQty(item, $event)"
                />
              </div>
            </div>

            <div class="mt-4 flex items-center justify-between text-sm">
              <span class="text-gray-600">Subtotal mensual</span>
              <span class="font-semibold text-gray-900">{{ formatMoney(subtotalCredits(item), currency) }}</span>
            </div>
          </div>
        </div>

        <aside class="space-y-4 lg:sticky lg:top-24">
          <div class="rounded-2xl border border-gray-200 bg-white p-5">
            <p class="text-xs font-semibold uppercase tracking-[0.25em] text-[#2b0f60]">Resumen</p>
            <div class="mt-4 grid gap-3">
              <div class="rounded-2xl bg-gray-50 border border-gray-100 p-4">
                <p class="text-xs text-gray-500">Total documentos/mes</p>
                <p class="text-xl font-semibold text-gray-900 mt-1">{{ formatNumber(totalDocs) }}</p>
              </div>
              <div class="rounded-2xl bg-gray-50 border border-gray-100 p-4">
                <p class="text-xs text-gray-500">Total estimado</p>
                <p class="text-xl font-semibold text-gray-900 mt-1">{{ formatMoney(totalCredits, currency) }}</p>
                <p class="text-xs text-gray-500 mt-1">Equivale a {{ formatNumber(totalCredits) }} créditos</p>
              </div>
              <div class="rounded-2xl bg-gray-50 border border-gray-100 p-4">
                <p class="text-xs text-gray-500">Promedio por documento</p>
                <p class="text-xl font-semibold text-gray-900 mt-1">{{ avgCreditsPerDoc }}</p>
                <p class="text-xs text-gray-500 mt-1">Créditos/doc (estimado)</p>
              </div>
            </div>
          </div>

          <div class="rounded-2xl border border-gray-200 bg-white p-5">
            <p class="text-sm font-semibold text-gray-900">
              {{ mode === 'credits' ? 'Cómo funciona con créditos' : 'Cómo funciona on-demand' }}
            </p>
            <p class="text-sm text-gray-600 mt-2 leading-relaxed" *ngIf="mode === 'credits'">
              Recargas un saldo (créditos) y cada firma descuenta automáticamente según el tipo de canal.
              Te ayuda a mantener un presupuesto más controlado.
            </p>
            <p class="text-sm text-gray-600 mt-2 leading-relaxed" *ngIf="mode === 'ondemand'">
              No compras créditos. Firmas libremente durante el periodo y se factura automáticamente al cierre.
              Es ideal si tu volumen varía y no quieres gestionar recargas.
            </p>
          </div>
        </aside>
      </div>
    </section>
  </div>
</div>
